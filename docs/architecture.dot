digraph sid_architecture {
    rankdir=LR;
    node [shape=record, fontname="Courier", fontsize=10];
    edge [fontname="Courier", fontsize=9];

    subgraph cluster_inputs {
        label="Input Pins";
        style=dashed;
        ui_in [label="ui_in[7:0]|{[2:0] reg_addr|[4:3] voice_sel|[7] wr_en}"];
        uio_in [label="uio_in[7:0]|wr_data"];
    }

    subgraph cluster_clkdiv {
        label="Clock Divider";
        style=filled; fillcolor="#f0e0fe";
        clk_div [label="÷3 Divider|12 MHz → 4 MHz\nclk_en_4m"];
    }

    subgraph cluster_regfile {
        label="Register File (x3 voices)";
        style=filled; fillcolor="#e8f0fe";
        regs [label="<f0>freq_lo[7:0]|<f1>freq_hi[7:0]|<pw0>pw_lo[7:0]|<pw1>pw_hi[3:0]|<ad>atk[3:0]/dec[7:4]|<sr>sus[3:0]/rel[7:4]|<wf>waveform[7:0]"];
    }

    subgraph cluster_pipeline {
        label="Pipeline Registers";
        style=filled; fillcolor="#fef7e0";
        p_regs [label="<pf>p_freq[15:0]|<ppw>p_pw[11:0]|<pacc>p_acc[15:0]|<pwf>p_waveform|<penv>p_env|<past>p_ast|..."];
    }

    subgraph cluster_datapath {
        label="Voice Datapath";
        style=filled; fillcolor="#e8fee8";
        osc [label="Oscillator|acc + freq\n(16-bit)"];
        wave [label="Waveform Gen|tri/saw/pulse/noise"];
        pulse_cmp [label="Pulse Compare|acc[15:4] \>= pw\n(12-bit)"];
        adsr [label="ADSR Envelope|8-bit, exp decay"];
        mult [label="Multiply|wave x env"];
    }

    subgraph cluster_output {
        label="Output";
        style=dashed;
        mix [label="3-Voice Mixer"];
        pwm [label="PWM DAC|8-bit, ~47.1 kHz\n(12 MHz)"];
        uo_out [label="uo_out[0]"];
    }

    clk_div -> p_regs [label="clk_en_4m"];
    clk_div -> osc [label="clk_en_4m"];
    ui_in -> regs;
    uio_in -> regs;
    regs:f0 -> p_regs:pf;
    regs:f1 -> p_regs:pf;
    regs:pw0 -> p_regs:ppw;
    regs:pw1 -> p_regs:ppw;
    p_regs:pf -> osc;
    p_regs:pacc -> osc;
    osc -> wave;
    p_regs:ppw -> pulse_cmp;
    osc -> pulse_cmp;
    pulse_cmp -> wave;
    p_regs -> adsr;
    wave -> mult;
    adsr -> mult;
    mult -> mix;
    mix -> pwm;
    pwm -> uo_out;
}
