# State Variable Filter (SVF) — Switched-Capacitor Design Document

## Overview

The SVF is a 2nd-order switched-capacitor (SC) analog filter implemented in the
IHP SG13G2 130nm BiCMOS process at VDD = 1.2V. It replaces the previous gm-C
topology to solve the capacitor scaling problem: 800 pF ideal caps would need
~730 µm per side in MIM, which is 16× the entire TT tile.

The SC approach replaces continuous-time transconductance (gm) with a clocked
capacitor: `R_eff = 1/(f_clk × C_sw)`, enabling audio-band filtering with
small on-chip MIM capacitors. The filter center frequency is tuned by changing
the switching clock frequency (digital control), and the Q factor is tuned via
a 4-bit binary-weighted capacitor array.

## Architecture

```
  sc_clk → [NOL Clock Gen] → phi1, phi2
                                │    │
  Vin ──→ [SC_R1: phi1/phi2] ──→ sum ──→ [OTA1: integrator] ──→ BP
                                  ↑        │                      │
  LP ───→ [SC_R2: phi1/phi2] ──→─┘        C_int1                 │
                                  ↑                                │
  BP ───→ [C_Q array: q0..q3] ──→┘        [OTA2: integrator] ←── BP
                                            │
                                           C_int2
                                            │
                                           LP ──→ feedback to SC_R2

  Output Mux (sel[1:0]):                 Q Tuning (q[3:0]):
  ┌──────────┬──────────────┐            ┌───────────────────────┐
  │ sel[1:0] │  Output      │            │ C_Q = Σ q[i]·2^i·Cu  │
  │──────────┼──────────────│            │ Cu = 73.5 fF          │
  │   00     │  HP          │            │ Q = C_int / C_Q       │
  │   01     │  BP          │            │ Range: Q≈1 to Q≈15   │
  │   10     │  LP          │            └───────────────────────┘
  │   11     │  Bypass      │
  └──────────┴──────────────┘
```

## SC Resistor Equivalent

A switched-capacitor resistor uses a small capacitor (C_sw) clocked between
two nodes at frequency f_clk to emulate a resistor:

```
  phi1 closes    phi2 closes
     │               │
     ▼               ▼
  in ──[sw1]── C_sw ──[sw2]── out
                │
               GND

  R_eff = 1 / (f_clk × C_sw)
```

With C_sw = 73.5 fF and f_clk = 93.75 kHz:
  R_eff = 1 / (93750 × 73.5e-15) = 145 MΩ

The non-overlapping clock generator (NOL) ensures phi1 and phi2 never
overlap, preventing charge sharing between input and output.

## Design Equations

```
         f_clk × C_sw
f₀ = ─────────────────      (Hz)
          2π × C_int

         C_int
Q  = ──────────
          C_Q

C_Q = Σ q[i] × 2^i × C_unit    (i = 0..3)
```

## Component Values

| Parameter | Value | Notes |
|-----------|-------|-------|
| C_sw | 73.5 fF | 7×7 µm MIM (minimum practical) |
| C_int | 1.1 pF | 27×27 µm MIM, 2 per SVF |
| C_Q unit | 73.5 fF | 7×7 µm MIM (= C_sw) |
| C_Q range | 73.5 fF – 1.1 pF | 4-bit binary, 15 codes |
| f_clk | 23.4 kHz – 1.5 MHz | 16 steps via divider LUT |
| f₀ | ~250 Hz – ~16 kHz | Tracks f_clk linearly |
| Q range | ~1 – ~15 | C_int / C_Q |
| OTAs | 2 | 5T diff pair (same as gm-C) |
| VCM | 0.6 V | VDD/2 |

## Frequency Tuning

The switching clock is generated by a programmable divider from the 24 MHz
system clock. The divider ratio is selected by `filt_fc[10:7]` (4 bits from
the SID register bank) via a LUT:

| Code | Divider | f_clk (kHz) | f₀ (Hz) |
|------|---------|-------------|---------|
| 0 | ÷1024 | 23.4 | ~250 |
| 1 | ÷768 | 31.3 | ~330 |
| 2 | ÷640 | 37.5 | ~400 |
| 3 | ÷512 | 46.9 | ~500 |
| 4 | ÷384 | 62.5 | ~660 |
| 5 | ÷320 | 75.0 | ~800 |
| 6 | ÷256 | 93.8 | ~1000 |
| 7 | ÷192 | 125 | ~1330 |
| 8 | ÷128 | 188 | ~2000 |
| 9 | ÷96 | 250 | ~2660 |
| 10 | ÷64 | 375 | ~4000 |
| 11 | ÷48 | 500 | ~5300 |
| 12 | ÷32 | 750 | ~8000 |
| 13 | ÷24 | 1000 | ~10600 |
| 14 | ÷20 | 1200 | ~12700 |
| 15 | ÷16 | 1500 | ~16000 |

This replaces the analog bias DAC used in the gm-C version, simplifying the
design and providing precise digital frequency control.

## Q Tuning

Q is controlled by a 4-bit binary-weighted MIM capacitor array (C_Q) that
connects between the BP node and the summing node:

```
  BP ──[sw_q0]── C_q0 (1×) ──┐
  BP ──[sw_q1]── C_q1 (2×) ──┤
  BP ──[sw_q2]── C_q2 (4×) ──┼── summing node
  BP ──[sw_q3]── C_q3 (8×) ──┘
```

| Code q[3:0] | C_Q (fF) | Q = C_int/C_Q |
|-------------|----------|---------------|
| 0001 | 73.5 | ~15.0 |
| 0010 | 147 | ~7.5 |
| 0100 | 294 | ~3.7 |
| 1000 | 588 | ~1.9 |
| 1111 | 1103 | ~1.0 |

The `filt_res[3:0]` register bits drive `q0..q3` directly (no DAC needed).

## OTA Topology

Each OTA is a 5-transistor differential pair with PMOS current mirror load
(identical to the gm-C version):

```
          VDD            VDD
           │              │
      ┌────┴────┐    ┌────┴────┐
      │  M3 (P) │    │  M4 (P) │     PMOS active load
      │  W=2µm  ├────┤  W=2µm  │     (current mirror)
      │  L=0.5µm│    │  L=0.5µm│
      └────┬────┘    └────┬────┘
           │              │
           │              ├────────── Vout
           │              │
      ┌────┴────┐    ┌────┴────┐
      │  M1 (N) │    │  M2 (N) │     NMOS differential pair
 V+ ──┤  W=4µm  │    │  W=4µm  ├── V-
      │  L=0.5µm│    │  L=0.5µm│
      └────┬────┘    └────┬────┘
           └──────┬───────┘
                  │
             ┌────┴────┐
             │  M5 (N) │              NMOS tail current source
    Vbias ───┤  W=2µm  │
             │  L=0.5µm│
             └────┬────┘
                  │
                 VSS
```

In the SC SVF, only 2 OTAs are needed (down from 4 in the gm-C version)
because the SC resistors handle the summing and damping functions that
previously required dedicated OTAs.

## Layout

The SC SVF macro (`svf_2nd`) occupies **70 × 85 µm** (same footprint):

```
  ┌──────────────────────────────────────────────────────────────────────┐
  │                          VDD rail (Metal3)                    85 µm │
  ├──────────────────────────────────────────────────────────────────────┤
  │  [OTA1: int1]     [OTA2: int2]                ← 2 OTAs       y≈65 │
  ├──────────────────────────────────────────────────────────────────────┤
  │                              [NOL Clock Gen]   ← clock gen    y≈58 │
  ├──────────────────────────────────────────────────────────────────────┤
  │  ┌──────────┐  ┌──────────┐  ┌─────────────────────────────┐       │
  │  │ C_int1   │  │ C_int2   │  │  C_Q array (4-bit)         │       │
  │  │ 27×27 µm │  │ 27×27 µm │  │  7×7 to 14×28 µm          │ y≈28 │
  │  │ (1.1 pF) │  │ (1.1 pF) │  │  (73.5 fF to 588 fF)      │       │
  │  └──────────┘  └──────────┘  └─────────────────────────────┘       │
  │  ┌────┐ ┌────┐                                                     │
  │  │C_sw│ │C_sw│               ← SC switching caps            y≈19  │
  │  │7×7 │ │7×7 │                 (73.5 fF each)                      │
  │  └────┘ └────┘                                                     │
  │  [SW1][SW2][SW3][SW4]         ← CMOS switches     ┌──────┐        │
  │                                                    │ MUX  │  y≈4  │
  │                                                    │ 4×   │        │
  │                                                    │ NMOS │        │
  │                                                    └──────┘        │
  ├──────────────────────────────────────────────────────────────────────┤
  │                          VSS rail (Metal3)                     0 µm │
  └──────────────────────────────────────────────────────────────────────┘
  0 µm                                                            70 µm
```

### Pin Map

| Pin | Layer | Edge | Y (µm) | Direction |
|-----|-------|------|---------|-----------|
| vin | Metal2 | Left | 42 | Input |
| vout | Metal2 | Right | 42 | Output |
| sel0 | Metal2 | Left | 10 | Input (mux control) |
| sel1 | Metal2 | Left | 16 | Input (mux control) |
| sc_clk | Metal2 | Left | 60 | Input (switching clock) |
| q0 | Metal2 | Left | 64 | Input (C_Q bit 0) |
| q1 | Metal2 | Left | 67 | Input (C_Q bit 1) |
| q2 | Metal2 | Left | 70 | Input (C_Q bit 2) |
| q3 | Metal2 | Left | 73 | Input (C_Q bit 3) |
| vdd | Metal3 | Top | 83–85 | Power |
| vss | Metal3 | Bottom | 0–2 | Ground |

### Component Summary

| Component | Count | Size | Notes |
|-----------|-------|------|-------|
| OTA (5T) | 2 | NMOS dp: W=4µm L=0.5µm | Integrators only |
| | | PMOS load: W=2µm L=0.5µm | |
| | | NMOS tail: W=2µm L=0.5µm | |
| MIM cap (C_int) | 2 | 27.1 × 27.1 µm each | ~1.1 pF |
| MIM cap (C_sw) | 2 | 7.0 × 7.0 µm each | ~73.5 fF |
| MIM cap (C_Q) | 4 | 7×7 to 14×28 µm | Binary-weighted array |
| CMOS switch | 8 | N: W=2µm L=0.13µm | SC resistors + C_Q |
| | | P: W=4µm L=0.13µm | |
| NOL clock gen | 1 | 8 transistors | 4 CMOS gate pairs |
| NMOS mux | 4 | W=2µm L=0.13µm | Output select |

### Area Comparison (gm-C vs SC)

| | gm-C SVF | SC SVF |
|---|----------|--------|
| OTAs | 4 × 5T = 20 transistors | 2 × 5T = 10 transistors |
| Bias circuits | 2 mirrors (4 transistors) | None (digital clock) |
| Caps | 2 × 25.8² µm (C_int only) | 2 × 27.1² + 2 × 7² + 4 × C_Q |
| Switches | 4 NMOS (mux only) | 8 CMOS + 4 NMOS mux |
| Clock gen | None | 8 transistors (NOL) |
| Fill | ~45% | ~51% |
| fc tuning | Analog bias DAC | Digital clock divider |
| Q tuning | Analog bias DAC | Digital cap switches |

## Digital Interface Changes

The SC SVF replaces the two analog bias current inputs with digital controls:

| Old (gm-C) | New (SC) | Type | Control |
|-------------|----------|------|---------|
| ibias_fc (analog) | sc_clk (digital) | Clock | Programmable divider from 24 MHz |
| ibias_q (analog) | q0, q1, q2, q3 | Digital | Direct from filt_res[3:0] |

This eliminates the `bias_dac_2ch` module from the digital top-level, replacing
it with a 10-bit counter + 16-entry divider LUT (~15 FFs + combinatorial logic).

## Verification

1. `ngspice -b svf/sc_svf_tb.spice` — standalone SC SVF simulation
2. `ngspice -b full_chain/full_chain_tb.spice` — DAC → SC SVF → ADC chain
3. `python3 layout/gen_sc_svf.py` — generate GDS
4. `python3 layout/run_drc.py macros/gds/svf_2nd.gds` — DRC check

## Simulation Results

The SC SVF has been characterized via the `filter_sweep` simulation suite,
which sweeps LP/BP/HP modes across 4 Q values (0.5, 1, 2, 5) and 4 cutoff
frequencies (250, 500, 1000, 1500 Hz) using a fixed 500 Hz input sine —
16 simulation segments total. Key results:

- **Low-pass**: passes signal when fc > f_in, attenuates when fc < f_in;
  resonant peak visible at Q = 5.
- **Band-pass**: peaks at fc = f_in (500 Hz), attenuated above and below;
  higher Q sharpens the peak.
- **High-pass**: passes signal when fc < f_in, attenuates when fc > f_in;
  resonant peak at Q = 5.

The full analog chain (R-2R DAC → SC SVF → SAR ADC) has also been verified
end-to-end via the `full_chain` and `full_sweep` simulations, including PWM
recovery through a 3rd-order RC filter.

See [`analog_sim/STATUS.md`](../STATUS.md) for complete results, plots, and
pass/fail status of all analog macro simulations.
